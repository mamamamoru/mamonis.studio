<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SQUASH BATCH - 一括画像圧縮</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg: #0a0a0a;
      --fg: #fafafa;
      --gray: #666;
      --border: #333;
      --success: #fafafa;
    }

    [data-theme="light"] {
      --bg: #fafafa;
      --fg: #0a0a0a;
      --gray: #888;
      --border: #ddd;
      --success: #0a0a0a;
    }

    body {
      font-family: 'Space Mono', monospace;
      background: var(--bg);
      color: var(--fg);
      min-height: 100vh;
      line-height: 1.6;
    }

    /* Top Navigation */
    .top-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      background: var(--bg);
      z-index: 100;
    }

    .nav-controls {
      display: flex;
      gap: 8px;
    }

    .nav-btn {
      background: none;
      border: 1px solid var(--border);
      color: var(--fg);
      padding: 6px 12px;
      font-family: inherit;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .nav-btn:hover {
      border-color: var(--fg);
    }

    .nav-btn.active {
      background: var(--fg);
      color: var(--bg);
    }

    .nav-logo {
      font-weight: 700;
      font-size: 0.9rem;
      text-decoration: none;
      color: var(--fg);
      letter-spacing: -0.5px;
    }

    .nav-logo:hover {
      opacity: 0.7;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    .main-header {
      text-align: center;
      margin-bottom: 60px;
    }

    .badge {
      display: inline-block;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--gray);
      margin-bottom: 15px;
    }

    h1 {
      font-size: 2.5rem;
      font-weight: 700;
      letter-spacing: -2px;
      margin-bottom: 8px;
    }

    .tagline {
      color: var(--gray);
      font-size: 0.85rem;
    }

    /* Drop Zone */
    .drop-zone {
      border: 2px dashed var(--border);
      padding: 80px 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 40px;
    }

    .drop-zone:hover,
    .drop-zone.dragover {
      border-color: var(--fg);
      background: rgba(255,255,255,0.02);
    }

    .drop-zone-icon {
      font-size: 3rem;
      margin-bottom: 20px;
      opacity: 0.6;
    }

    .drop-zone-text {
      font-size: 1rem;
      margin-bottom: 8px;
    }

    .drop-zone-hint {
      font-size: 0.75rem;
      color: var(--gray);
    }

    /* Settings */
    .settings {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
      padding: 30px;
      border: 1px solid var(--border);
    }

    .setting-group label {
      display: block;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--gray);
      margin-bottom: 8px;
    }

    .setting-group select,
    .setting-group input[type="range"] {
      width: 100%;
      padding: 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--fg);
      font-family: inherit;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .setting-group select:focus {
      outline: none;
      border-color: var(--fg);
    }

    .quality-display {
      text-align: right;
      font-size: 1.5rem;
      font-weight: 700;
      margin-top: 8px;
    }

    /* File List */
    .file-list {
      margin-bottom: 40px;
    }

    .file-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 10px;
    }

    .file-count {
      font-size: 0.85rem;
      color: var(--gray);
    }

    .clear-btn {
      background: none;
      border: 1px solid var(--border);
      color: var(--fg);
      padding: 8px 16px;
      font-family: inherit;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .clear-btn:hover {
      border-color: var(--fg);
    }

    .file-item {
      display: grid;
      grid-template-columns: 60px 1fr auto auto;
      gap: 15px;
      align-items: center;
      padding: 15px 0;
      border-bottom: 1px solid var(--border);
    }

    .file-thumb {
      width: 60px;
      height: 60px;
      object-fit: cover;
      filter: grayscale(100%);
    }

    .file-info {
      overflow: hidden;
    }

    .file-name {
      font-size: 0.85rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 4px;
    }

    .file-size {
      font-size: 0.75rem;
      color: var(--gray);
    }

    .file-status {
      font-size: 0.75rem;
      text-align: right;
      min-width: 100px;
    }

    .file-status.processing {
      color: var(--gray);
    }

    .file-status.done {
      color: var(--success);
    }

    .file-savings {
      font-size: 0.85rem;
      font-weight: 700;
      min-width: 80px;
      text-align: right;
    }

    .file-savings.good {
      color: var(--fg);
    }

    /* Actions */
    .actions {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .btn {
      flex: 1;
      min-width: 200px;
      padding: 18px 30px;
      font-family: inherit;
      font-size: 0.85rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .btn-primary {
      background: var(--fg);
      color: var(--bg);
    }

    .btn-primary:hover:not(:disabled) {
      opacity: 0.9;
      transform: translateY(-2px);
    }

    .btn-primary:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: transparent;
      color: var(--fg);
      border: 1px solid var(--fg);
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--fg);
      color: var(--bg);
    }

    .btn-secondary:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    /* Progress */
    .progress-bar {
      width: 100%;
      height: 4px;
      background: var(--border);
      margin-bottom: 40px;
      display: none;
    }

    .progress-bar.active {
      display: block;
    }

    .progress-fill {
      height: 100%;
      background: var(--fg);
      width: 0%;
      transition: width 0.3s;
    }

    /* Summary */
    .summary {
      display: none;
      text-align: center;
      padding: 40px;
      border: 1px solid var(--fg);
      margin-bottom: 40px;
    }

    .summary.active {
      display: block;
    }

    .summary-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: var(--gray);
      margin-bottom: 15px;
    }

    .summary-value {
      font-size: 3rem;
      font-weight: 700;
    }

    .summary-detail {
      font-size: 0.85rem;
      color: var(--gray);
      margin-top: 10px;
    }

    /* Footer */
    footer {
      text-align: center;
      margin-top: 80px;
      padding-top: 40px;
      border-top: 1px solid var(--border);
      color: var(--gray);
      font-size: 0.75rem;
    }

    footer a {
      color: var(--fg);
      text-decoration: none;
    }

    footer a:hover {
      opacity: 0.7;
    }

    /* Hidden input */
    #file-input {
      display: none;
    }

    /* Responsive */
    @media (max-width: 600px) {
      h1 {
        font-size: 1.8rem;
      }

      .file-item {
        grid-template-columns: 50px 1fr;
        gap: 10px;
      }

      .file-savings,
      .file-status {
        grid-column: 2;
        text-align: left;
      }

      .settings {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Top Navigation -->
  <nav class="top-nav">
    <div class="nav-controls">
      <button class="nav-btn active" id="lang-jp" onclick="setLang('ja')">JP</button>
      <button class="nav-btn" id="lang-en" onclick="setLang('en')">EN</button>
    </div>
    <div class="nav-controls">
      <button class="nav-btn active" id="theme-dark" onclick="setTheme('dark')">Dark</button>
      <button class="nav-btn" id="theme-light" onclick="setTheme('light')">Light</button>
    </div>
    <a href="https://mamonis.studio/" class="nav-logo">Mamonis</a>
  </nav>

  <div class="container">
    <header class="main-header">
      <span class="badge">Browser-based Tool</span>
      <h1>SQUASH BATCH</h1>
      <p class="tagline" data-i18n="tagline">一括画像圧縮 / 広告なし / 制限なし / 完全ローカル処理</p>
    </header>

    <input type="file" id="file-input" accept="image/*,.heic,.heif" multiple>

    <div class="drop-zone" id="drop-zone">
      <div class="drop-zone-icon">□</div>
      <p class="drop-zone-text" data-i18n="dropText">画像をドロップ または クリックして選択</p>
      <p class="drop-zone-hint" data-i18n="dropHint">PNG, JPG, WebP, AVIF, <strong>HEIC</strong> 対応 / 枚数制限なし</p>
    </div>

    <div class="settings">
      <div class="setting-group">
        <label data-i18n="formatLabel">出力形式</label>
        <select id="format-select">
          <option value="webp" data-i18n="formatWebp">WebP (推奨)</option>
          <option value="mozjpeg" data-i18n="formatMozjpeg">MozJPEG</option>
          <option value="avif" data-i18n="formatAvif">AVIF (最小)</option>
          <option value="oxipng" data-i18n="formatPng">PNG (ロスレス)</option>
        </select>
      </div>

      <div class="setting-group">
        <label data-i18n="presetLabel">プリセット</label>
        <select id="preset-select">
          <option value="80" data-i18n="presetWeb">Web用 (80%)</option>
          <option value="60" data-i18n="presetSns">SNS用 (60%)</option>
          <option value="40" data-i18n="presetMin">最小サイズ (40%)</option>
          <option value="custom" data-i18n="presetCustom">カスタム</option>
        </select>
      </div>

      <div class="setting-group">
        <label data-i18n="qualityLabel">品質</label>
        <input type="range" id="quality-range" min="10" max="100" value="80">
        <div class="quality-display" id="quality-display">80%</div>
      </div>
    </div>

    <div class="progress-bar" id="progress-bar">
      <div class="progress-fill" id="progress-fill"></div>
    </div>

    <div class="summary" id="summary">
      <div class="summary-title" data-i18n="summaryTitle">合計削減サイズ</div>
      <div class="summary-value" id="summary-value">-</div>
      <div class="summary-detail" id="summary-detail"></div>
    </div>

    <div class="file-list" id="file-list" style="display: none;">
      <div class="file-list-header">
        <span class="file-count" id="file-count">0 files</span>
        <button class="clear-btn" id="clear-btn" data-i18n="clearBtn">クリア</button>
      </div>
      <div id="file-items"></div>
    </div>

    <div class="actions">
      <button class="btn btn-primary" id="compress-btn" data-i18n="compressBtn" disabled>圧縮開始</button>
      <button class="btn btn-secondary" id="download-btn" data-i18n="downloadBtn" disabled>ZIP ダウンロード</button>
    </div>

    <footer>
      <p><a href="https://mamonis.studio/">© 2026 Mamonis Studio</a> · <span data-i18n="footerFree">完全無料</span> · <span data-i18n="footerNoServer">サーバー送信なし</span> · <span data-i18n="footerPrivacy">プライバシー保護</span></p>
    </footer>
  </div>

  <script type="module">
    // ========== I18N & Theme ==========
    const translations = {
      ja: {
        tagline: '一括画像圧縮 / 広告なし / 制限なし / 完全ローカル処理',
        dropText: '画像をドロップ または クリックして選択',
        dropHint: 'PNG, JPG, WebP, AVIF, <strong>HEIC</strong> 対応 / 枚数制限なし',
        formatLabel: '出力形式',
        formatWebp: 'WebP (推奨)',
        formatMozjpeg: 'MozJPEG',
        formatAvif: 'AVIF (最小)',
        formatPng: 'PNG (ロスレス)',
        presetLabel: 'プリセット',
        presetWeb: 'Web用 (80%)',
        presetSns: 'SNS用 (60%)',
        presetMin: '最小サイズ (40%)',
        presetCustom: 'カスタム',
        qualityLabel: '品質',
        summaryTitle: '合計削減サイズ',
        clearBtn: 'クリア',
        compressBtn: '圧縮開始',
        downloadBtn: 'ZIP ダウンロード',
        footerFree: '完全無料',
        footerNoServer: 'サーバー送信なし',
        footerPrivacy: 'プライバシー保護',
        statusWaiting: '待機中',
        statusProcessing: '処理中...',
        statusHeic: 'HEIC変換中...',
        statusError: 'エラー',
        filesLabel: 'ファイル',
        reduced: '削減'
      },
      en: {
        tagline: 'Batch image compression / No ads / No limits / 100% local',
        dropText: 'Drop images or click to select',
        dropHint: 'PNG, JPG, WebP, AVIF, <strong>HEIC</strong> supported / No file limit',
        formatLabel: 'Output Format',
        formatWebp: 'WebP (Recommended)',
        formatMozjpeg: 'MozJPEG',
        formatAvif: 'AVIF (Smallest)',
        formatPng: 'PNG (Lossless)',
        presetLabel: 'Preset',
        presetWeb: 'Web (80%)',
        presetSns: 'Social (60%)',
        presetMin: 'Minimum (40%)',
        presetCustom: 'Custom',
        qualityLabel: 'Quality',
        summaryTitle: 'Total Reduction',
        clearBtn: 'Clear',
        compressBtn: 'Compress',
        downloadBtn: 'Download ZIP',
        footerFree: 'Free',
        footerNoServer: 'No server upload',
        footerPrivacy: 'Privacy protected',
        statusWaiting: 'Waiting',
        statusProcessing: 'Processing...',
        statusHeic: 'Converting HEIC...',
        statusError: 'Error',
        filesLabel: 'files',
        reduced: 'saved'
      }
    };

    let currentLang = localStorage.getItem('lang') || 'ja';
    let currentTheme = localStorage.getItem('theme') || 'dark';

    function setLang(lang) {
      currentLang = lang;
      localStorage.setItem('lang', lang);
      document.documentElement.lang = lang;
      
      // Update nav buttons
      document.getElementById('lang-jp').classList.toggle('active', lang === 'ja');
      document.getElementById('lang-en').classList.toggle('active', lang === 'en');
      
      // Update all translatable elements
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[lang][key]) {
          if (el.tagName === 'OPTION') {
            el.textContent = translations[lang][key];
          } else {
            el.innerHTML = translations[lang][key];
          }
        }
      });
      
      // Update file list if visible
      if (typeof updateFileList === 'function' && files.length > 0) {
        updateFileList();
      }
    }

    function setTheme(theme) {
      currentTheme = theme;
      localStorage.setItem('theme', theme);
      document.documentElement.setAttribute('data-theme', theme);
      
      // Update nav buttons
      document.getElementById('theme-dark').classList.toggle('active', theme === 'dark');
      document.getElementById('theme-light').classList.toggle('active', theme === 'light');
    }

    // Make functions global for onclick handlers
    window.setLang = setLang;
    window.setTheme = setTheme;

    // Initialize theme and language
    setTheme(currentTheme);
    setLang(currentLang);
    // jSquash CDN imports
    const codecs = {
      webp: () => import('https://esm.sh/@jsquash/webp@1.4.0'),
      mozjpeg: () => import('https://esm.sh/@jsquash/jpeg@1.4.0'),
      avif: () => import('https://esm.sh/@jsquash/avif@1.3.0'),
      oxipng: () => import('https://esm.sh/@jsquash/png@3.0.1'),
      // Decoders
      jpegDecode: () => import('https://esm.sh/@jsquash/jpeg@1.4.0'),
      pngDecode: () => import('https://esm.sh/@jsquash/png@3.0.1'),
      webpDecode: () => import('https://esm.sh/@jsquash/webp@1.4.0'),
      // HEIC decoder
      heicTo: () => import('https://esm.sh/heic-to@1.3.0'),
    };

    // Check if file is HEIC
    function isHeicFile(file) {
      const name = file.name.toLowerCase();
      return name.endsWith('.heic') || name.endsWith('.heif') || 
             file.type === 'image/heic' || file.type === 'image/heif';
    }

    // State
    let files = [];
    let compressedFiles = [];
    let loadedCodecs = {};

    // DOM elements
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const fileList = document.getElementById('file-list');
    const fileItems = document.getElementById('file-items');
    const fileCount = document.getElementById('file-count');
    const clearBtn = document.getElementById('clear-btn');
    const compressBtn = document.getElementById('compress-btn');
    const downloadBtn = document.getElementById('download-btn');
    const formatSelect = document.getElementById('format-select');
    const presetSelect = document.getElementById('preset-select');
    const qualityRange = document.getElementById('quality-range');
    const qualityDisplay = document.getElementById('quality-display');
    const progressBar = document.getElementById('progress-bar');
    const progressFill = document.getElementById('progress-fill');
    const summary = document.getElementById('summary');
    const summaryValue = document.getElementById('summary-value');
    const summaryDetail = document.getElementById('summary-detail');

    // Utility functions
    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function getExtension(format) {
      const ext = { webp: 'webp', mozjpeg: 'jpg', avif: 'avif', oxipng: 'png' };
      return ext[format] || 'webp';
    }

    // Decode image to ImageData
    async function decodeImage(file) {
      // Handle HEIC files first
      if (isHeicFile(file)) {
        if (!loadedCodecs.heicTo) {
          loadedCodecs.heicTo = await codecs.heicTo();
        }
        // Convert HEIC to JPEG blob first
        const jpegBlob = await loadedCodecs.heicTo.heicTo({
          blob: file,
          type: 'image/jpeg',
          quality: 1.0
        });
        // Then decode the JPEG
        const buffer = await jpegBlob.arrayBuffer();
        if (!loadedCodecs.jpegDecode) {
          loadedCodecs.jpegDecode = await codecs.jpegDecode();
        }
        return await loadedCodecs.jpegDecode.decode(buffer);
      }

      const buffer = await file.arrayBuffer();
      const type = file.type;

      if (type === 'image/jpeg' || type === 'image/jpg') {
        if (!loadedCodecs.jpegDecode) {
          loadedCodecs.jpegDecode = await codecs.jpegDecode();
        }
        return await loadedCodecs.jpegDecode.decode(buffer);
      } else if (type === 'image/png') {
        if (!loadedCodecs.pngDecode) {
          loadedCodecs.pngDecode = await codecs.pngDecode();
        }
        return await loadedCodecs.pngDecode.decode(buffer);
      } else if (type === 'image/webp') {
        if (!loadedCodecs.webpDecode) {
          loadedCodecs.webpDecode = await codecs.webpDecode();
        }
        return await loadedCodecs.webpDecode.decode(buffer);
      } else {
        // Fallback: use canvas for other formats
        return await decodeWithCanvas(file);
      }
    }

    async function decodeWithCanvas(file) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          const imageData = ctx.getImageData(0, 0, img.width, img.height);
          URL.revokeObjectURL(img.src);
          resolve(imageData);
        };
        img.onerror = reject;
        img.src = URL.createObjectURL(file);
      });
    }

    // Encode image
    async function encodeImage(imageData, format, quality) {
      if (!loadedCodecs[format]) {
        loadedCodecs[format] = await codecs[format]();
      }

      const codec = loadedCodecs[format];
      const q = quality / 100;

      switch (format) {
        case 'webp':
          return await codec.encode(imageData, { quality });
        case 'mozjpeg':
          return await codec.encode(imageData, { quality });
        case 'avif':
          // AVIF uses cqLevel (0-63, lower = better quality)
          const cqLevel = Math.round((1 - q) * 63);
          return await codec.encode(imageData, { cqLevel });
        case 'oxipng':
          // PNG is lossless, quality doesn't apply
          return await codec.encode(imageData, { level: 2 });
        default:
          throw new Error('Unknown format');
      }
    }

    // Update UI
    function updateFileList() {
      fileItems.innerHTML = '';
      files.forEach((file, index) => {
        const item = document.createElement('div');
        item.className = 'file-item';
        item.id = `file-${index}`;

        const thumb = document.createElement('img');
        thumb.className = 'file-thumb';
        
        // HEIC files can't be displayed directly in browser
        if (isHeicFile(file)) {
          // Use a simple placeholder for HEIC
          thumb.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 60 60"><rect fill="%23333" width="60" height="60"/><text x="50%" y="50%" fill="%23888" font-family="monospace" font-size="10" text-anchor="middle" dy=".3em">HEIC</text></svg>';
        } else {
          thumb.src = URL.createObjectURL(file);
        }

        const info = document.createElement('div');
        info.className = 'file-info';
        info.innerHTML = `
          <div class="file-name">${file.name}</div>
          <div class="file-size">${formatBytes(file.size)}</div>
        `;

        const status = document.createElement('div');
        status.className = 'file-status';
        status.id = `status-${index}`;
        status.textContent = translations[currentLang].statusWaiting;

        const savings = document.createElement('div');
        savings.className = 'file-savings';
        savings.id = `savings-${index}`;
        savings.textContent = '-';

        item.appendChild(thumb);
        item.appendChild(info);
        item.appendChild(status);
        item.appendChild(savings);
        fileItems.appendChild(item);
      });

      fileCount.textContent = `${files.length} ${translations[currentLang].filesLabel}`;
      fileList.style.display = files.length > 0 ? 'block' : 'none';
      compressBtn.disabled = files.length === 0;
      downloadBtn.disabled = true;
      summary.classList.remove('active');
    }

    // Event listeners
    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      const newFiles = Array.from(e.dataTransfer.files).filter(f => 
        f.type.startsWith('image/') || isHeicFile(f)
      );
      files = [...files, ...newFiles];
      updateFileList();
    });

    fileInput.addEventListener('change', (e) => {
      const newFiles = Array.from(e.target.files);
      files = [...files, ...newFiles];
      updateFileList();
    });

    clearBtn.addEventListener('click', () => {
      files = [];
      compressedFiles = [];
      updateFileList();
    });

    presetSelect.addEventListener('change', (e) => {
      if (e.target.value !== 'custom') {
        qualityRange.value = e.target.value;
        qualityDisplay.textContent = e.target.value + '%';
      }
    });

    qualityRange.addEventListener('input', (e) => {
      qualityDisplay.textContent = e.target.value + '%';
      presetSelect.value = 'custom';
    });

    // Compress
    compressBtn.addEventListener('click', async () => {
      const format = formatSelect.value;
      const quality = parseInt(qualityRange.value);

      compressBtn.disabled = true;
      downloadBtn.disabled = true;
      progressBar.classList.add('active');
      compressedFiles = [];

      let totalOriginal = 0;
      let totalCompressed = 0;

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const statusEl = document.getElementById(`status-${i}`);
        const savingsEl = document.getElementById(`savings-${i}`);

        statusEl.textContent = isHeicFile(file) ? translations[currentLang].statusHeic : translations[currentLang].statusProcessing;
        statusEl.className = 'file-status processing';

        try {
          const imageData = await decodeImage(file);
          const encoded = await encodeImage(imageData, format, quality);

          const originalSize = file.size;
          const compressedSize = encoded.byteLength;
          const savings = ((1 - compressedSize / originalSize) * 100).toFixed(0);

          totalOriginal += originalSize;
          totalCompressed += compressedSize;

          const ext = getExtension(format);
          const newName = file.name.replace(/\.[^/.]+$/, '') + '.' + ext;

          compressedFiles.push({
            name: newName,
            data: encoded,
            originalSize,
            compressedSize
          });

          statusEl.textContent = formatBytes(compressedSize);
          statusEl.className = 'file-status done';
          savingsEl.textContent = `-${savings}%`;
          savingsEl.className = 'file-savings good';

        } catch (err) {
          console.error('Error processing:', file.name, err);
          statusEl.textContent = translations[currentLang].statusError;
          statusEl.className = 'file-status';
        }

        progressFill.style.width = `${((i + 1) / files.length) * 100}%`;
      }

      // Show summary
      const totalSavings = ((1 - totalCompressed / totalOriginal) * 100).toFixed(0);
      summaryValue.textContent = `-${totalSavings}%`;
      summaryDetail.textContent = `${formatBytes(totalOriginal)} → ${formatBytes(totalCompressed)} (${formatBytes(totalOriginal - totalCompressed)} ${translations[currentLang].reduced})`;
      summary.classList.add('active');

      compressBtn.disabled = false;
      downloadBtn.disabled = compressedFiles.length === 0;

      setTimeout(() => {
        progressBar.classList.remove('active');
        progressFill.style.width = '0%';
      }, 1000);
    });

    // Download ZIP
    downloadBtn.addEventListener('click', async () => {
      const { default: JSZip } = await import('https://esm.sh/jszip@3.10.1');

      const zip = new JSZip();
      compressedFiles.forEach(file => {
        zip.file(file.name, file.data);
      });

      const content = await zip.generateAsync({ type: 'blob' });
      const url = URL.createObjectURL(content);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'squash-batch-output.zip';
      a.click();
      URL.revokeObjectURL(url);
    });

    // Preload primary codec
    (async () => {
      try {
        loadedCodecs.webp = await codecs.webp();
        console.log('WebP codec loaded');
      } catch (e) {
        console.log('Codec preload deferred');
      }
    })();
  </script>
</body>
</html>
